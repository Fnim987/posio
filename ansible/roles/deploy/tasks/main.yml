---

  - name: copy
    become: yes
    copy:
      src: kubedeploy.yaml
      dest: /home/ubuntu/kubedeploy.yaml
      
  - name: copy
    become: yes
    copy:
      src: kube.sh
      dest: /home/ubuntu/kube.sh
      
  - name: check the status of minikube.
    command: minikube status
    register: minikube_status
    changed_when: false
    ignore_errors: true

  - name: start minikube if it's not running.
    command: minikube start 
    when: "not minikube_status.stdout or 'Running' not in minikube_status.stdout"
    
  - name: start app
    shell: |
      kubectl apply -f kubedeploy.yaml
      sleep 10
      nohup kubectl port-forward deploy/posio 8000:5000 --address='0.0.0.0' </dev/null >/dev/null 2>&1 &
    async: 20
    poll: 0
    
    
  - name: reset ssh connection to allow user changes to affect ansible user
    ansible.builtin.meta:
      reset_connection

  - name: start app
    shell: |
      nohup kubectl port-forward deploy/posio 8000:5000 --address='0.0.0.0' </dev/null >/dev/null 2>&1 &
    async: 20
    poll: 0
  #- name: start app
    #shell: |
      #sudo chmod +x kube.sh
      #./kube.sh
    #async: 20
    #poll: 0

